<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>微服务保护 | Xstudy</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/xstudy/img/logo1.ico">
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?b17d02e4e0a8eeddf8b55aa8c0f1e764";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
  </script>
    <script language="javascript" type="text/javascript" src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
    <script language="javascript" type="text/javascript" src="/xstudy/js/MouseClickEffect.js"></script>
    <script language="javascript" type="text/javascript" src="/xstudy/js/enhanceAPP.js"></script>
    <meta name="description" content="my study record">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="baidu-site-verification" content="code-bGotmcnXsO">
    
    <link rel="preload" href="/xstudy/assets/css/0.styles.d9f88a7e.css" as="style"><link rel="preload" href="/xstudy/assets/js/app.3d6c3b03.js" as="script"><link rel="preload" href="/xstudy/assets/js/19.64802264.js" as="script"><link rel="preload" href="/xstudy/assets/js/1.09d9e8ff.js" as="script"><link rel="preload" href="/xstudy/assets/js/3.4370b068.js" as="script"><link rel="prefetch" href="/xstudy/assets/js/10.9e505c78.js"><link rel="prefetch" href="/xstudy/assets/js/100.065dabe9.js"><link rel="prefetch" href="/xstudy/assets/js/101.57752f52.js"><link rel="prefetch" href="/xstudy/assets/js/102.3ec8fed4.js"><link rel="prefetch" href="/xstudy/assets/js/103.7f060987.js"><link rel="prefetch" href="/xstudy/assets/js/104.9dd47d3f.js"><link rel="prefetch" href="/xstudy/assets/js/105.4714601f.js"><link rel="prefetch" href="/xstudy/assets/js/106.33219791.js"><link rel="prefetch" href="/xstudy/assets/js/107.b091b3b9.js"><link rel="prefetch" href="/xstudy/assets/js/108.b8d5655f.js"><link rel="prefetch" href="/xstudy/assets/js/109.8c440b71.js"><link rel="prefetch" href="/xstudy/assets/js/11.7aaf4552.js"><link rel="prefetch" href="/xstudy/assets/js/110.6a81c441.js"><link rel="prefetch" href="/xstudy/assets/js/111.3326509f.js"><link rel="prefetch" href="/xstudy/assets/js/112.0d27a1a2.js"><link rel="prefetch" href="/xstudy/assets/js/113.38774043.js"><link rel="prefetch" href="/xstudy/assets/js/114.b733495d.js"><link rel="prefetch" href="/xstudy/assets/js/115.1aa4eb46.js"><link rel="prefetch" href="/xstudy/assets/js/116.9eb44980.js"><link rel="prefetch" href="/xstudy/assets/js/117.62f8b73e.js"><link rel="prefetch" href="/xstudy/assets/js/118.0c8efeba.js"><link rel="prefetch" href="/xstudy/assets/js/119.50712dbe.js"><link rel="prefetch" href="/xstudy/assets/js/12.4dfbae75.js"><link rel="prefetch" href="/xstudy/assets/js/120.a89dc5ab.js"><link rel="prefetch" href="/xstudy/assets/js/121.a1bf37f0.js"><link rel="prefetch" href="/xstudy/assets/js/122.eb894b94.js"><link rel="prefetch" href="/xstudy/assets/js/123.c7c6732d.js"><link rel="prefetch" href="/xstudy/assets/js/124.e7b8c439.js"><link rel="prefetch" href="/xstudy/assets/js/125.6635c3ed.js"><link rel="prefetch" href="/xstudy/assets/js/126.d9699570.js"><link rel="prefetch" href="/xstudy/assets/js/127.88e2af70.js"><link rel="prefetch" href="/xstudy/assets/js/128.f201ee6a.js"><link rel="prefetch" href="/xstudy/assets/js/129.5694996d.js"><link rel="prefetch" href="/xstudy/assets/js/13.73d71fdc.js"><link rel="prefetch" href="/xstudy/assets/js/130.f3b34ef8.js"><link rel="prefetch" href="/xstudy/assets/js/131.86f3482e.js"><link rel="prefetch" href="/xstudy/assets/js/132.0f2538d4.js"><link rel="prefetch" href="/xstudy/assets/js/133.af44239a.js"><link rel="prefetch" href="/xstudy/assets/js/134.8e313b62.js"><link rel="prefetch" href="/xstudy/assets/js/135.c9b3e3a8.js"><link rel="prefetch" href="/xstudy/assets/js/136.1101692e.js"><link rel="prefetch" href="/xstudy/assets/js/137.ca5e68ba.js"><link rel="prefetch" href="/xstudy/assets/js/138.4d17bbd8.js"><link rel="prefetch" href="/xstudy/assets/js/139.5605035c.js"><link rel="prefetch" href="/xstudy/assets/js/14.e8a123ad.js"><link rel="prefetch" href="/xstudy/assets/js/140.6ead4839.js"><link rel="prefetch" href="/xstudy/assets/js/141.a0ad2973.js"><link rel="prefetch" href="/xstudy/assets/js/142.e45d497c.js"><link rel="prefetch" href="/xstudy/assets/js/143.e03322af.js"><link rel="prefetch" href="/xstudy/assets/js/144.7ce4488b.js"><link rel="prefetch" href="/xstudy/assets/js/145.597ccc38.js"><link rel="prefetch" href="/xstudy/assets/js/146.25b7c7aa.js"><link rel="prefetch" href="/xstudy/assets/js/147.19f2ea49.js"><link rel="prefetch" href="/xstudy/assets/js/148.aa2a8314.js"><link rel="prefetch" href="/xstudy/assets/js/149.8ba299bb.js"><link rel="prefetch" href="/xstudy/assets/js/15.c41aa653.js"><link rel="prefetch" href="/xstudy/assets/js/150.06d588a8.js"><link rel="prefetch" href="/xstudy/assets/js/151.409eaf70.js"><link rel="prefetch" href="/xstudy/assets/js/152.907b336d.js"><link rel="prefetch" href="/xstudy/assets/js/153.4a0d59ae.js"><link rel="prefetch" href="/xstudy/assets/js/154.81dffa5e.js"><link rel="prefetch" href="/xstudy/assets/js/155.f466274f.js"><link rel="prefetch" href="/xstudy/assets/js/156.3e337c60.js"><link rel="prefetch" href="/xstudy/assets/js/157.52d5423e.js"><link rel="prefetch" href="/xstudy/assets/js/158.0bf9a908.js"><link rel="prefetch" href="/xstudy/assets/js/159.138024e6.js"><link rel="prefetch" href="/xstudy/assets/js/16.dc1514b4.js"><link rel="prefetch" href="/xstudy/assets/js/160.dce4d5d9.js"><link rel="prefetch" href="/xstudy/assets/js/161.4d73e91a.js"><link rel="prefetch" href="/xstudy/assets/js/162.2c0abd94.js"><link rel="prefetch" href="/xstudy/assets/js/163.15fff109.js"><link rel="prefetch" href="/xstudy/assets/js/164.017d4274.js"><link rel="prefetch" href="/xstudy/assets/js/165.b3069502.js"><link rel="prefetch" href="/xstudy/assets/js/166.eae77c2f.js"><link rel="prefetch" href="/xstudy/assets/js/167.fbb610cc.js"><link rel="prefetch" href="/xstudy/assets/js/168.e08e8d04.js"><link rel="prefetch" href="/xstudy/assets/js/169.300d5878.js"><link rel="prefetch" href="/xstudy/assets/js/17.6d036c62.js"><link rel="prefetch" href="/xstudy/assets/js/170.bd3f045b.js"><link rel="prefetch" href="/xstudy/assets/js/171.fd8361eb.js"><link rel="prefetch" href="/xstudy/assets/js/172.2544084e.js"><link rel="prefetch" href="/xstudy/assets/js/173.1a4e39ce.js"><link rel="prefetch" href="/xstudy/assets/js/174.a0f0cf50.js"><link rel="prefetch" href="/xstudy/assets/js/175.17468be0.js"><link rel="prefetch" href="/xstudy/assets/js/18.2642cef9.js"><link rel="prefetch" href="/xstudy/assets/js/20.b7ed91a2.js"><link rel="prefetch" href="/xstudy/assets/js/21.389d7d4e.js"><link rel="prefetch" href="/xstudy/assets/js/22.926d3140.js"><link rel="prefetch" href="/xstudy/assets/js/23.2d8a8692.js"><link rel="prefetch" href="/xstudy/assets/js/24.8e4d89b3.js"><link rel="prefetch" href="/xstudy/assets/js/25.99f3a3d1.js"><link rel="prefetch" href="/xstudy/assets/js/26.18e9c4b2.js"><link rel="prefetch" href="/xstudy/assets/js/27.6526c1ed.js"><link rel="prefetch" href="/xstudy/assets/js/28.4322ec4a.js"><link rel="prefetch" href="/xstudy/assets/js/29.60f029d5.js"><link rel="prefetch" href="/xstudy/assets/js/30.3e1bc698.js"><link rel="prefetch" href="/xstudy/assets/js/31.b44cf23d.js"><link rel="prefetch" href="/xstudy/assets/js/32.16f7d057.js"><link rel="prefetch" href="/xstudy/assets/js/33.868fc9fc.js"><link rel="prefetch" href="/xstudy/assets/js/34.90a94613.js"><link rel="prefetch" href="/xstudy/assets/js/35.9f008119.js"><link rel="prefetch" href="/xstudy/assets/js/36.19a72ee9.js"><link rel="prefetch" href="/xstudy/assets/js/37.a29485d4.js"><link rel="prefetch" href="/xstudy/assets/js/38.9e503ccf.js"><link rel="prefetch" href="/xstudy/assets/js/39.f882199a.js"><link rel="prefetch" href="/xstudy/assets/js/4.df1fb657.js"><link rel="prefetch" href="/xstudy/assets/js/40.bb38eb7e.js"><link rel="prefetch" href="/xstudy/assets/js/41.0a0e8892.js"><link rel="prefetch" href="/xstudy/assets/js/42.ee7c55d5.js"><link rel="prefetch" href="/xstudy/assets/js/43.ec85f03b.js"><link rel="prefetch" href="/xstudy/assets/js/44.cf439fbd.js"><link rel="prefetch" href="/xstudy/assets/js/45.bbdfa21c.js"><link rel="prefetch" href="/xstudy/assets/js/46.5b3a05f8.js"><link rel="prefetch" href="/xstudy/assets/js/47.2c6b5b7a.js"><link rel="prefetch" href="/xstudy/assets/js/48.e2d99bca.js"><link rel="prefetch" href="/xstudy/assets/js/49.da575daa.js"><link rel="prefetch" href="/xstudy/assets/js/5.f5f9fcd7.js"><link rel="prefetch" href="/xstudy/assets/js/50.5dc0b092.js"><link rel="prefetch" href="/xstudy/assets/js/51.5090323d.js"><link rel="prefetch" href="/xstudy/assets/js/52.f17a6c74.js"><link rel="prefetch" href="/xstudy/assets/js/53.7e407da9.js"><link rel="prefetch" href="/xstudy/assets/js/54.eeba64ae.js"><link rel="prefetch" href="/xstudy/assets/js/55.bf276748.js"><link rel="prefetch" href="/xstudy/assets/js/56.2f503b71.js"><link rel="prefetch" href="/xstudy/assets/js/57.2eb18d4a.js"><link rel="prefetch" href="/xstudy/assets/js/58.8fc4a91e.js"><link rel="prefetch" href="/xstudy/assets/js/59.43013c02.js"><link rel="prefetch" href="/xstudy/assets/js/6.acca9de8.js"><link rel="prefetch" href="/xstudy/assets/js/60.c281bd3b.js"><link rel="prefetch" href="/xstudy/assets/js/61.09ca19a1.js"><link rel="prefetch" href="/xstudy/assets/js/62.2d3dcbcd.js"><link rel="prefetch" href="/xstudy/assets/js/63.8c6a84a8.js"><link rel="prefetch" href="/xstudy/assets/js/64.a6b74307.js"><link rel="prefetch" href="/xstudy/assets/js/65.e984f895.js"><link rel="prefetch" href="/xstudy/assets/js/66.70b3dace.js"><link rel="prefetch" href="/xstudy/assets/js/67.4f317baf.js"><link rel="prefetch" href="/xstudy/assets/js/68.82b63769.js"><link rel="prefetch" href="/xstudy/assets/js/69.7a5a14ed.js"><link rel="prefetch" href="/xstudy/assets/js/7.5fe409d5.js"><link rel="prefetch" href="/xstudy/assets/js/70.2b4322f2.js"><link rel="prefetch" href="/xstudy/assets/js/71.3b479114.js"><link rel="prefetch" href="/xstudy/assets/js/72.60df85f8.js"><link rel="prefetch" href="/xstudy/assets/js/73.ccc8041f.js"><link rel="prefetch" href="/xstudy/assets/js/74.bd916aee.js"><link rel="prefetch" href="/xstudy/assets/js/75.02a42354.js"><link rel="prefetch" href="/xstudy/assets/js/76.afa4a7d0.js"><link rel="prefetch" href="/xstudy/assets/js/77.4dcb8d58.js"><link rel="prefetch" href="/xstudy/assets/js/78.f14c7eaf.js"><link rel="prefetch" href="/xstudy/assets/js/79.941a2930.js"><link rel="prefetch" href="/xstudy/assets/js/8.ce9a12cc.js"><link rel="prefetch" href="/xstudy/assets/js/80.11affd3b.js"><link rel="prefetch" href="/xstudy/assets/js/81.6b276616.js"><link rel="prefetch" href="/xstudy/assets/js/82.9a2c356d.js"><link rel="prefetch" href="/xstudy/assets/js/83.fb20d08e.js"><link rel="prefetch" href="/xstudy/assets/js/84.00568eed.js"><link rel="prefetch" href="/xstudy/assets/js/85.9043e674.js"><link rel="prefetch" href="/xstudy/assets/js/86.7f2eeacd.js"><link rel="prefetch" href="/xstudy/assets/js/87.565a3ce4.js"><link rel="prefetch" href="/xstudy/assets/js/88.b4e6e8db.js"><link rel="prefetch" href="/xstudy/assets/js/89.fa5ebb43.js"><link rel="prefetch" href="/xstudy/assets/js/9.89838fa8.js"><link rel="prefetch" href="/xstudy/assets/js/90.26b66eba.js"><link rel="prefetch" href="/xstudy/assets/js/91.bbf6ddb0.js"><link rel="prefetch" href="/xstudy/assets/js/92.ec8f6228.js"><link rel="prefetch" href="/xstudy/assets/js/93.605d953e.js"><link rel="prefetch" href="/xstudy/assets/js/94.9efdb0ae.js"><link rel="prefetch" href="/xstudy/assets/js/95.22fdddcb.js"><link rel="prefetch" href="/xstudy/assets/js/96.280d495a.js"><link rel="prefetch" href="/xstudy/assets/js/97.ed5489b5.js"><link rel="prefetch" href="/xstudy/assets/js/98.754d578b.js"><link rel="prefetch" href="/xstudy/assets/js/99.161fe63d.js">
    <link rel="stylesheet" href="/xstudy/assets/css/0.styles.d9f88a7e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-1156296a><div data-v-1156296a><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1156296a data-v-1156296a><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4e82dffc data-v-1156296a data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>Xstudy</h3> <p class="description" data-v-4e82dffc data-v-4e82dffc>my study record</p> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>默</span>
            
          <span data-v-4e82dffc>2021 - </span>
          2023
        </a></span></div></div> <div class="hide" data-v-1156296a><header class="navbar" data-v-1156296a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/xstudy/" class="home-link router-link-active"><img src="/xstudy/img/logo.jpg" alt="Xstudy" class="logo"> <span class="site-name">Xstudy</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/xstudy/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      摸鱼心得
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xstudy/categories/数据结构/" class="nav-link"><i class="undefined"></i>
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/xstudy/categories/框架/" class="nav-link"><i class="undefined"></i>
  框架
</a></li><li class="dropdown-item"><!----> <a href="/xstudy/categories/java/" class="nav-link"><i class="undefined"></i>
  java
</a></li><li class="dropdown-item"><!----> <a href="/xstudy/categories/中间件/" class="nav-link"><i class="undefined"></i>
  中间件
</a></li><li class="dropdown-item"><!----> <a href="/xstudy/categories/算法/" class="nav-link"><i class="undefined"></i>
  算法
</a></li></ul></div></div><div class="nav-item"><a href="/xstudy/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/xstudy/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  日志
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      开源
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Palelie/xstudy" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/Palelies/xstudy" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-mayun"></i>
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1156296a></div> <aside class="sidebar" data-v-1156296a><div class="personal-info-wrapper" data-v-828910c6 data-v-1156296a><img src="/xstudy/img/logo.jpg" alt="author-avatar" class="personal-img" data-v-828910c6> <h3 class="name" data-v-828910c6>
    默
  </h3> <div class="num" data-v-828910c6><div data-v-828910c6><h3 data-v-828910c6>165</h3> <h6 data-v-828910c6>Articles</h6></div> <div data-v-828910c6><h3 data-v-828910c6>25</h3> <h6 data-v-828910c6>Tags</h6></div></div> <ul class="social-links" data-v-828910c6></ul> <hr data-v-828910c6></div> <nav class="nav-links"><div class="nav-item"><a href="/xstudy/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      摸鱼心得
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xstudy/categories/数据结构/" class="nav-link"><i class="undefined"></i>
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/xstudy/categories/框架/" class="nav-link"><i class="undefined"></i>
  框架
</a></li><li class="dropdown-item"><!----> <a href="/xstudy/categories/java/" class="nav-link"><i class="undefined"></i>
  java
</a></li><li class="dropdown-item"><!----> <a href="/xstudy/categories/中间件/" class="nav-link"><i class="undefined"></i>
  中间件
</a></li><li class="dropdown-item"><!----> <a href="/xstudy/categories/算法/" class="nav-link"><i class="undefined"></i>
  算法
</a></li></ul></div></div><div class="nav-item"><a href="/xstudy/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/xstudy/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  日志
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      开源
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Palelie/xstudy" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/Palelies/xstudy" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-mayun"></i>
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>框架</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xstudy/blogs/frame/xuyan.html" class="sidebar-link">序言</a></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>Mybatis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xstudy/blogs/frame/Mybatis.html" class="sidebar-link">Mybatis</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>Spring</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xstudy/blogs/frame/spring.html" class="sidebar-link">Spring</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>Mybatis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xstudy/blogs/frame/springMVC/SpringMVC.html" class="sidebar-link">SpringMVC</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>SpringBoot</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xstudy/blogs/frame/springboot2/SpringBoot.html" class="sidebar-link">SpringBoot</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>Mybatis-Plus</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xstudy/blogs/frame/mybatis_plus/MyBatis_Plus.html" class="sidebar-link">MyBatis-Plus</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>Spring Cloud</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xstudy/blogs/frame/Spring-Cloud/SpringCloud01.html" class="sidebar-link">Spring Cloud 01</a></li><li><a href="/xstudy/blogs/frame/Spring-Cloud/SpringCloud02.html" class="sidebar-link">Spring Cloud 02</a></li><li><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html" aria-current="page" class="active sidebar-link">微服务保护</a></li><li><a href="/xstudy/blogs/frame/Spring-Cloud/Seata.html" class="sidebar-link">分布式事务</a></li></ul></section></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4e82dffc data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>微服务保护</h3> <!----> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>默</span>
            
          <span data-v-4e82dffc>2021 - </span>
          2023
        </a></span></div></div> <div data-v-1156296a><main class="page"><section><div class="page-title"><h1 class="title">微服务保护</h1> <div data-v-1ff7123e><i class="iconfont reco-account" data-v-1ff7123e><span data-v-1ff7123e>默</span></i> <i class="iconfont reco-date" data-v-1ff7123e><span data-v-1ff7123e>2/23/2023</span></i> <!----> <i class="tags iconfont reco-tag" data-v-1ff7123e><span class="tag-item" data-v-1ff7123e>Sentinel</span></i></div></div> <div class="theme-reco-content content__default"><h1 id="微服务保护"><a href="#微服务保护" class="header-anchor">#</a> 微服务保护</h1> <h1 id="_1-初识sentinel"><a href="#_1-初识sentinel" class="header-anchor">#</a> 1.初识Sentinel</h1> <h2 id="_1-1-雪崩问题及解决方案"><a href="#_1-1-雪崩问题及解决方案" class="header-anchor">#</a> 1.1.雪崩问题及解决方案</h2> <h3 id="_1-1-1-雪崩问题"><a href="#_1-1-1-雪崩问题" class="header-anchor">#</a> 1.1.1.雪崩问题</h3> <p>微服务中，服务间调用关系错综复杂，一个微服务往往依赖于多个其它微服务。</p> <p><img src="/xstudy/assets/img/1533829099748.976f74e6.png" alt="1533829099748"></p> <p>如图，如果服务提供者I发生了故障，当前的应用的部分业务因为依赖于服务I，因此也会被阻塞。此时，其它不依赖于服务I的业务似乎不受影响。</p> <p><img src="/xstudy/assets/img/1533829198240.b8d06384.png" alt="1533829198240"></p> <p>但是，依赖服务I的业务请求被阻塞，用户不会得到响应，则tomcat的这个线程不会释放，于是越来越多的用户请求到来，越来越多的线程会阻塞：</p> <p><img src="/xstudy/assets/img/1533829307389.3e771489.png" alt="1533829307389"></p> <p>服务器支持的线程和并发数有限，请求一直阻塞，会导致服务器资源耗尽，从而导致所有其它服务都不可用，那么当前服务也就不可用了。</p> <p>那么，依赖于当前服务的其它服务随着时间的推移，最终也都会变的不可用，形成级联失败，雪崩就发生了：</p> <p><img src="/xstudy/assets/img/image-20210715172710340.50ae2f63.png" alt="image-20210715172710340"></p> <h3 id="_1-1-2-超时处理"><a href="#_1-1-2-超时处理" class="header-anchor">#</a> 1.1.2.超时处理</h3> <p>解决雪崩问题的常见方式有四种：</p> <p>•超时处理：设定超时时间，请求超过一定时间没有响应就返回错误信息，不会无休止等待</p> <p><img src="/xstudy/assets/img/image-20210715172820438.a77a5b47.png" alt="image-20210715172820438"></p> <h3 id="_1-1-3-仓壁模式"><a href="#_1-1-3-仓壁模式" class="header-anchor">#</a> 1.1.3.仓壁模式</h3> <p>方案2：仓壁模式</p> <p>仓壁模式来源于船舱的设计：</p> <p><img src="/xstudy/assets/img/image-20210715172946352.d83d71a0.png" alt="image-20210715172946352"></p> <p>船舱都会被隔板分离为多个独立空间，当船体破损时，只会导致部分空间进入，将故障控制在一定范围内，避免整个船体都被淹没。</p> <p>于此类似，我们可以限定每个业务能使用的线程数，避免耗尽整个tomcat的资源，因此也叫线程隔离。</p> <p><img src="/xstudy/assets/img/image-20210715173215243.2391fa4b.png" alt="image-20210715173215243"></p> <h3 id="_1-1-4-断路器"><a href="#_1-1-4-断路器" class="header-anchor">#</a> 1.1.4.断路器</h3> <p>断路器模式：由<strong>断路器</strong>统计业务执行的异常比例，如果超出阈值则会<strong>熔断</strong>该业务，拦截访问该业务的一切请求。</p> <p>断路器会统计访问某个服务的请求数量，异常比例：</p> <p><img src="/xstudy/assets/img/image-20210715173327075.32770b97.png" alt="image-20210715173327075"></p> <p>当发现访问服务D的请求异常比例过高时，认为服务D有导致雪崩的风险，会拦截访问服务D的一切请求，形成熔断：</p> <p><img src="/xstudy/assets/img/image-20210715173428073.7bc5e928.png" alt="image-20210715173428073"></p> <h3 id="_1-1-5-限流"><a href="#_1-1-5-限流" class="header-anchor">#</a> 1.1.5.限流</h3> <p><strong>流量控制</strong>：限制业务访问的QPS，避免服务因流量的突增而故障。</p> <p><img src="/xstudy/assets/img/image-20210715173555158.254cf2e5.png" alt="image-20210715173555158"></p> <h3 id="_1-1-6-总结"><a href="#_1-1-6-总结" class="header-anchor">#</a> 1.1.6.总结</h3> <p>什么是雪崩问题？</p> <ul><li>微服务之间相互调用，因为调用链中的一个服务故障，引起整个链路都无法访问的情况。</li></ul> <p>可以认为：</p> <p><strong>限流</strong>是对服务的保护，避免因瞬间高并发流量而导致服务故障，进而避免雪崩。是一种<strong>预防</strong>措施。</p> <p><strong>超时处理、线程隔离、降级熔断</strong>是在部分服务故障时，将故障控制在一定范围，避免雪崩。是一种<strong>补救</strong>措施。</p> <h2 id="_1-2-服务保护技术对比"><a href="#_1-2-服务保护技术对比" class="header-anchor">#</a> 1.2.服务保护技术对比</h2> <p>在SpringCloud当中支持多种服务保护技术：</p> <ul><li><a href="https://github.com/Netflix/Hystrix" target="_blank" rel="noopener noreferrer">Netfix Hystrix<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/alibaba/Sentinel" target="_blank" rel="noopener noreferrer">Sentinel<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/resilience4j/resilience4j" target="_blank" rel="noopener noreferrer">Resilience4J<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>早期比较流行的是Hystrix框架，但目前国内实用最广泛的还是阿里巴巴的Sentinel框架，这里我们做下对比：</p> <table><thead><tr><th></th> <th><strong>Sentinel</strong></th> <th><strong>Hystrix</strong></th></tr></thead> <tbody><tr><td>隔离策略</td> <td>信号量隔离</td> <td>线程池隔离/信号量隔离</td></tr> <tr><td>熔断降级策略</td> <td>基于慢调用比例或异常比例</td> <td>基于失败比率</td></tr> <tr><td>实时指标实现</td> <td>滑动窗口</td> <td>滑动窗口（基于 RxJava）</td></tr> <tr><td>规则配置</td> <td>支持多种数据源</td> <td>支持多种数据源</td></tr> <tr><td>扩展性</td> <td>多个扩展点</td> <td>插件的形式</td></tr> <tr><td>基于注解的支持</td> <td>支持</td> <td>支持</td></tr> <tr><td>限流</td> <td>基于 QPS，支持基于调用关系的限流</td> <td>有限的支持</td></tr> <tr><td>流量整形</td> <td>支持慢启动、匀速排队模式</td> <td>不支持</td></tr> <tr><td>系统自适应保护</td> <td>支持</td> <td>不支持</td></tr> <tr><td>控制台</td> <td>开箱即用，可配置规则、查看秒级监控、机器发现等</td> <td>不完善</td></tr> <tr><td>常见框架的适配</td> <td>Servlet、Spring Cloud、Dubbo、gRPC  等</td> <td>Servlet、Spring Cloud Netflix</td></tr></tbody></table> <h2 id="_1-3-sentinel介绍和安装"><a href="#_1-3-sentinel介绍和安装" class="header-anchor">#</a> 1.3.Sentinel介绍和安装</h2> <h3 id="_1-3-1-初识sentinel"><a href="#_1-3-1-初识sentinel" class="header-anchor">#</a> 1.3.1.初识Sentinel</h3> <p>Sentinel是阿里巴巴开源的一款微服务流量控制组件。官网地址：https://sentinelguard.io/zh-cn/index.html</p> <p>Sentinel 具有以下特征:</p> <p>•<strong>丰富的应用场景</strong>：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。</p> <p>•<strong>完备的实时监控</strong>：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。</p> <p>•<strong>广泛的开源生态</strong>：Sentinel 提供开箱即用的与其它开源框架/库的整合模块，例如与 Spring Cloud、Dubbo、gRPC 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。</p> <p>•<strong>完善的</strong> <strong>SPI</strong> <strong>扩展点</strong>：Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等。</p> <h3 id="_1-3-2-安装sentinel"><a href="#_1-3-2-安装sentinel" class="header-anchor">#</a> 1.3.2.安装Sentinel</h3> <p>1）下载</p> <p>sentinel官方提供了UI控制台，方便我们对系统做限流设置。大家可以在<a href="https://github.com/alibaba/Sentinel/releases" target="_blank" rel="noopener noreferrer">GitHub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>下载。</p> <p>课前资料也提供了下载好的jar包：</p> <p><img src="/xstudy/assets/img/image-20210715174252531.7ea627c1.png" alt="image-20210715174252531"></p> <p>2）运行</p> <p>将jar包放到任意非中文目录，执行命令：</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">java</span> <span class="token parameter variable">-jar</span> sentinel-dashboard-1.8.1.jar
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果要修改Sentinel的默认端口、账户、密码，可以通过下列配置：</p> <table><thead><tr><th><strong>配置项</strong></th> <th><strong>默认值</strong></th> <th><strong>说明</strong></th></tr></thead> <tbody><tr><td>server.port</td> <td>8080</td> <td>服务端口</td></tr> <tr><td>sentinel.dashboard.auth.username</td> <td>sentinel</td> <td>默认用户名</td></tr> <tr><td>sentinel.dashboard.auth.password</td> <td>sentinel</td> <td>默认密码</td></tr></tbody></table> <p>例如，修改端口：</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">java</span> <span class="token parameter variable">-Dserver.port</span><span class="token operator">=</span><span class="token number">8090</span> <span class="token parameter variable">-jar</span> sentinel-dashboard-1.8.1.jar
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>3）访问</p> <p>访问http://localhost:8080页面，就可以看到sentinel的控制台了：</p> <p><img src="/xstudy/assets/img/image-20210715190827846.f7928f93.png" alt="image-20210715190827846"></p> <p>需要输入账号和密码，默认都是：sentinel</p> <p>登录后，发现一片空白，什么都没有：</p> <p><img src="/xstudy/assets/img/image-20210715191134448.019bb7e3.png" alt="image-20210715191134448"></p> <p>这是因为我们还没有与微服务整合。</p> <h2 id="_1-4-微服务整合sentinel"><a href="#_1-4-微服务整合sentinel" class="header-anchor">#</a> 1.4.微服务整合Sentinel</h2> <p>我们在order-service中整合sentinel，并连接sentinel的控制台，步骤如下：</p> <p>1）引入sentinel依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!--sentinel--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-sentinel<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>2）配置控制台</p> <p>修改application.yaml文件，添加下面内容：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8088</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span> 
    <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
      <span class="token key atrule">transport</span><span class="token punctuation">:</span>
        <span class="token key atrule">dashboard</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8080</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>3）访问order-service的任意端点</p> <p>打开浏览器，访问http://localhost:8088/order/101，这样才能触发sentinel的监控。</p> <p>然后再访问sentinel的控制台，查看效果：</p> <p><img src="/xstudy/assets/img/image-20210715191241799.fb910e1d.png" alt="image-20210715191241799"></p> <h1 id="_2-流量控制"><a href="#_2-流量控制" class="header-anchor">#</a> 2.流量控制</h1> <p>雪崩问题虽然有四种方案，但是限流是避免服务因突发的流量而发生故障，是对微服务雪崩问题的预防。我们先学习这种模式。</p> <h2 id="_2-1-簇点链路"><a href="#_2-1-簇点链路" class="header-anchor">#</a> 2.1.簇点链路</h2> <p>当请求进入微服务时，首先会访问DispatcherServlet，然后进入Controller、Service、Mapper，这样的一个调用链就叫做<strong>簇点链路</strong>。簇点链路中被监控的每一个接口就是一个<strong>资源</strong>。</p> <p>默认情况下sentinel会监控SpringMVC的每一个端点（Endpoint，也就是controller中的方法），因此SpringMVC的每一个端点（Endpoint）就是调用链路中的一个资源。</p> <p>例如，我们刚才访问的order-service中的OrderController中的端点：/order/{orderId}</p> <p><img src="/xstudy/assets/img/image-20210715191757319.c644ac82.png" alt="image-20210715191757319"></p> <p>流控、熔断等都是针对簇点链路中的资源来设置的，因此我们可以点击对应资源后面的按钮来设置规则：</p> <ul><li>流控：流量控制</li> <li>降级：降级熔断</li> <li>热点：热点参数限流，是限流的一种</li> <li>授权：请求的权限控制</li></ul> <h2 id="_2-1-快速入门"><a href="#_2-1-快速入门" class="header-anchor">#</a> 2.1.快速入门</h2> <h3 id="_2-1-1-示例"><a href="#_2-1-1-示例" class="header-anchor">#</a> 2.1.1.示例</h3> <p>点击资源/order/{orderId}后面的流控按钮，就可以弹出表单。</p> <p><img src="/xstudy/assets/img/image-20210715191757319.c644ac82.png" alt="image-20210715191757319"></p> <p>表单中可以填写限流规则，如下：</p> <p><img src="/xstudy/assets/img/image-20210715192010657.7e5f2359.png" alt="image-20210715192010657"></p> <p>其含义是限制 /order/{orderId}这个资源的单机QPS为1，即每秒只允许1次请求，超出的请求会被拦截并报错。</p> <h3 id="_2-1-2-练习"><a href="#_2-1-2-练习" class="header-anchor">#</a> 2.1.2.练习：</h3> <p>需求：给 /order/{orderId}这个资源设置流控规则，QPS不能超过 5，然后测试。</p> <p>1）首先在sentinel控制台添加限流规则</p> <p><img src="/xstudy/assets/img/image-20210715192455429.e31a07b2.png" alt="image-20210715192455429"></p> <p>2）利用jmeter测试</p> <p>如果没有用过jmeter，可以参考课前资料提供的文档《Jmeter快速入门.md》</p> <p>课前资料提供了编写好的Jmeter测试样例：</p> <p><img src="/xstudy/assets/img/image-20210715200431615.025e011a.png" alt="image-20210715200431615"></p> <p>打开jmeter，导入课前资料提供的测试样例：</p> <p><img src="data:image/png;base64,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" alt="image-20210715200537171"></p> <p>选择：</p> <p><img src="/xstudy/assets/img/image-20210715200635414.0d72ce25.png" alt="image-20210715200635414"></p> <p>20个用户，2秒内运行完，QPS是10，超过了5.</p> <p>选中<code>流控入门，QPS&lt;5</code>右键运行：</p> <p><img src="/xstudy/assets/img/image-20210715200804594.d435d9e7.png" alt="image-20210715200804594"></p> <blockquote><p>注意，不要点击菜单中的执行按钮来运行。</p></blockquote> <p>结果：</p> <p><img src="/xstudy/assets/img/image-20210715200853671.740614f3.png" alt="image-20210715200853671"></p> <p>可以看到，成功的请求每次只有5个</p> <h2 id="_2-2-流控模式"><a href="#_2-2-流控模式" class="header-anchor">#</a> 2.2.流控模式</h2> <p>在添加限流规则时，点击高级选项，可以选择三种<strong>流控模式</strong>：</p> <ul><li>直接：统计当前资源的请求，触发阈值时对当前资源直接限流，也是默认的模式</li> <li>关联：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流</li> <li>链路：统计从指定链路访问到本资源的请求，触发阈值时，对指定链路限流</li></ul> <p><img src="/xstudy/assets/img/image-20210715201827886.d4971193.png" alt="image-20210715201827886"></p> <p>快速入门测试的就是直接模式。</p> <h3 id="_2-2-1-关联模式"><a href="#_2-2-1-关联模式" class="header-anchor">#</a> 2.2.1.关联模式</h3> <p><strong>关联模式</strong>：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流</p> <p><strong>配置规则</strong>：</p> <p><img src="/xstudy/assets/img/image-20210715202540786.960f3c52.png" alt="image-20210715202540786"></p> <p><strong>语法说明</strong>：当/write资源访问量触发阈值时，就会对/read资源限流，避免影响/write资源。</p> <p><strong>使用场景</strong>：比如用户支付时需要修改订单状态，同时用户要查询订单。查询和修改操作会争抢数据库锁，产生竞争。业务需求是优先支付和更新订单的业务，因此当修改订单业务触发阈值时，需要对查询订单业务限流。</p> <p><strong>需求说明</strong>：</p> <ul><li><p>在OrderController新建两个端点：/order/query和/order/update，无需实现业务</p></li> <li><p>配置流控规则，当/order/ update资源被访问的QPS超过5时，对/order/query请求限流</p></li></ul> <p>1）定义/order/query端点，模拟订单查询</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/query&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">queryOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;查询订单成功&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>2）定义/order/update端点，模拟订单更新</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/update&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">updateOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;更新订单成功&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>重启服务，查看sentinel控制台的簇点链路：</p> <p><img src="/xstudy/assets/img/image-20210716101805951.7056a01d.png" alt="image-20210716101805951"></p> <p>3）配置流控规则</p> <p>对哪个端点限流，就点击哪个端点后面的按钮。我们是对订单查询/order/query限流，因此点击它后面的按钮：</p> <p><img src="/xstudy/assets/img/image-20210716101934499.4ff54507.png" alt="image-20210716101934499"></p> <p>在表单中填写流控规则：</p> <p><img src="/xstudy/assets/img/image-20210716102103814.b1e14089.png" alt="image-20210716102103814"></p> <p>4）在Jmeter测试</p> <p>选择《流控模式-关联》：</p> <p><img src="/xstudy/assets/img/image-20210716102416266.1ff5d098.png" alt="image-20210716102416266"></p> <p>可以看到1000个用户，100秒，因此QPS为10，超过了我们设定的阈值：5</p> <p>查看http请求：</p> <p><img src="/xstudy/assets/img/image-20210716102532554.d4fd0c77.png" alt="image-20210716102532554"></p> <p>请求的目标是/order/update，这样这个断点就会触发阈值。</p> <p>但限流的目标是/order/query，我们在浏览器访问，可以发现：</p> <p><img src="/xstudy/assets/img/image-20210716102636030.13985fa5.png" alt="image-20210716102636030"></p> <p>确实被限流了。</p> <p>5）总结</p> <p><img src="/xstudy/assets/img/image-20210716103143002.4815ec6e.png" alt="image-20210716103143002"></p> <h3 id="_2-2-2-链路模式"><a href="#_2-2-2-链路模式" class="header-anchor">#</a> 2.2.2.链路模式</h3> <p><strong>链路模式</strong>：只针对从指定链路访问到本资源的请求做统计，判断是否超过阈值。</p> <p><strong>配置示例</strong>：</p> <p>例如有两条请求链路：</p> <ul><li><p>/test1 --&gt; /common</p></li> <li><p>/test2 --&gt; /common</p></li></ul> <p>如果只希望统计从/test2进入到/common的请求，则可以这样配置：</p> <p><img src="/xstudy/assets/img/image-20210716103536346.47ed6f18.png" alt="image-20210716103536346"></p> <p><strong>实战案例</strong></p> <p>需求：有查询订单和创建订单业务，两者都需要查询商品。针对从查询订单进入到查询商品的请求统计，并设置限流。</p> <p>步骤：</p> <ol><li><p>在OrderService中添加一个queryGoods方法，不用实现业务</p></li> <li><p>在OrderController中，改造/order/query端点，调用OrderService中的queryGoods方法</p></li> <li><p>在OrderController中添加一个/order/save的端点，调用OrderService的queryGoods方法</p></li> <li><p>给queryGoods设置限流规则，从/order/query进入queryGoods的方法限制QPS必须小于2</p></li></ol> <p>实现：</p> <h4 id="_1-添加查询商品方法"><a href="#_1-添加查询商品方法" class="header-anchor">#</a> 1）添加查询商品方法</h4> <p>在order-service服务中，给OrderService类添加一个queryGoods方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">queryGoods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;查询商品&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_2-查询订单时-查询商品"><a href="#_2-查询订单时-查询商品" class="header-anchor">#</a> 2）查询订单时，查询商品</h4> <p>在order-service的OrderController中，修改/order/query端点的业务逻辑：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/query&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">queryOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 查询商品</span>
    orderService<span class="token punctuation">.</span><span class="token function">queryGoods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 查询订单</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;查询订单&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;查询订单成功&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="_3-新增订单-查询商品"><a href="#_3-新增订单-查询商品" class="header-anchor">#</a> 3）新增订单，查询商品</h4> <p>在order-service的OrderController中，修改/order/save端点，模拟新增订单：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/save&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">saveOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 查询商品</span>
    orderService<span class="token punctuation">.</span><span class="token function">queryGoods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 查询订单</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;新增订单&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;新增订单成功&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="_4-给查询商品添加资源标记"><a href="#_4-给查询商品添加资源标记" class="header-anchor">#</a> 4）给查询商品添加资源标记</h4> <p>默认情况下，OrderService中的方法是不被Sentinel监控的，需要我们自己通过注解来标记要监控的方法。</p> <p>给OrderService的queryGoods方法添加@SentinelResource注解：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span><span class="token string">&quot;goods&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">queryGoods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;查询商品&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>链路模式中，是对不同来源的两个链路做监控。但是sentinel默认会给进入SpringMVC的所有请求设置同一个root资源，会导致链路模式失效。</p> <p>我们需要关闭这种对SpringMVC的资源聚合，修改order-service服务的application.yml文件：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
      <span class="token key atrule">web-context-unify</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 关闭context整合</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>重启服务，访问/order/query和/order/save，可以查看到sentinel的簇点链路规则中，出现了新的资源：</p> <p><img src="/xstudy/assets/img/image-20210716105227163.4f3cbd61.png" alt="image-20210716105227163"></p> <h4 id="_5-添加流控规则"><a href="#_5-添加流控规则" class="header-anchor">#</a> 5）添加流控规则</h4> <p>点击goods资源后面的流控按钮，在弹出的表单中填写下面信息：</p> <p><img src="/xstudy/assets/img/image-20210716105408723.470b0f19.png" alt="image-20210716105408723"></p> <p>只统计从/order/query进入/goods的资源，QPS阈值为2，超出则被限流。</p> <h4 id="_6-jmeter测试"><a href="#_6-jmeter测试" class="header-anchor">#</a> 6）Jmeter测试</h4> <p>选择《流控模式-链路》：</p> <p><img src="/xstudy/assets/img/image-20210716105612312.f36a267a.png" alt="image-20210716105612312"></p> <p>可以看到这里200个用户，50秒内发完，QPS为4，超过了我们设定的阈值2</p> <p>一个http请求是访问/order/save：</p> <p><img src="/xstudy/assets/img/image-20210716105812789.3dd359c7.png" alt="image-20210716105812789"></p> <p>运行的结果：</p> <p><img src="/xstudy/assets/img/image-20210716110027064.ec5915b2.png" alt="image-20210716110027064"></p> <p>完全不受影响。</p> <p>另一个是访问/order/query：</p> <p><img src="/xstudy/assets/img/image-20210716105855951.4633e62b.png" alt="image-20210716105855951"></p> <p>运行结果：</p> <p><img src="/xstudy/assets/img/image-20210716105956401.c49c538c.png" alt="image-20210716105956401"></p> <p>每次只有2个通过。</p> <h3 id="_2-2-3-总结"><a href="#_2-2-3-总结" class="header-anchor">#</a> 2.2.3.总结</h3> <p>流控模式有哪些？</p> <p>•直接：对当前资源限流</p> <p>•关联：高优先级资源触发阈值，对低优先级资源限流。</p> <p>•链路：阈值统计时，只统计从指定资源进入当前资源的请求，是对请求来源的限流</p> <h2 id="_2-3-流控效果"><a href="#_2-3-流控效果" class="header-anchor">#</a> 2.3.流控效果</h2> <p>在流控的高级选项中，还有一个流控效果选项：</p> <p><img src="/xstudy/assets/img/image-20210716110225104.8778eae6.png" alt="image-20210716110225104"></p> <p>流控效果是指请求达到流控阈值时应该采取的措施，包括三种：</p> <ul><li><p>快速失败：达到阈值后，新的请求会被立即拒绝并抛出FlowException异常。是默认的处理方式。</p></li> <li><p>warm up：预热模式，对超出阈值的请求同样是拒绝并抛出异常。但这种模式阈值会动态变化，从一个较小值逐渐增加到最大阈值。</p></li> <li><p>排队等待：让所有的请求按照先后次序排队执行，两个请求的间隔不能小于指定时长</p></li></ul> <h3 id="_2-3-1-warm-up"><a href="#_2-3-1-warm-up" class="header-anchor">#</a> 2.3.1.warm up</h3> <p>阈值一般是一个微服务能承担的最大QPS，但是一个服务刚刚启动时，一切资源尚未初始化（<strong>冷启动</strong>），如果直接将QPS跑到最大值，可能导致服务瞬间宕机。</p> <p>warm up也叫<strong>预热模式</strong>，是应对服务冷启动的一种方案。请求阈值初始值是 maxThreshold / coldFactor，持续指定时长后，逐渐提高到maxThreshold值。而coldFactor的默认值是3.</p> <p>例如，我设置QPS的maxThreshold为10，预热时间为5秒，那么初始阈值就是 10 / 3 ，也就是3，然后在5秒后逐渐增长到10.</p> <p><img src="/xstudy/assets/img/image-20210716110629796.4dcef0cb.png" alt="image-20210716110629796"></p> <p><strong>案例</strong></p> <p>需求：给/order/{orderId}这个资源设置限流，最大QPS为10，利用warm up效果，预热时长为5秒</p> <h4 id="_1-配置流控规则"><a href="#_1-配置流控规则" class="header-anchor">#</a> 1）配置流控规则：</h4> <p><img src="/xstudy/assets/img/image-20210716111012387.522fb88c.png" alt="image-20210716111012387"></p> <h4 id="_2-jmeter测试"><a href="#_2-jmeter测试" class="header-anchor">#</a> 2）Jmeter测试</h4> <p>选择《流控效果，warm up》：</p> <p><img src="/xstudy/assets/img/image-20210716111136699.6d9f686c.png" alt="image-20210716111136699"></p> <p>QPS为10.</p> <p>刚刚启动时，大部分请求失败，成功的只有3个，说明QPS被限定在3：</p> <p><img src="/xstudy/assets/img/image-20210716111303701.504cb31e.png" alt="image-20210716111303701"></p> <p>随着时间推移，成功比例越来越高：</p> <p><img src="/xstudy/assets/img/image-20210716111404717.b43e4a6c.png" alt="image-20210716111404717"></p> <p>到Sentinel控制台查看实时监控：</p> <p><img src="/xstudy/assets/img/image-20210716111526480.a0897486.png" alt="image-20210716111526480"></p> <p>一段时间后：</p> <p><img src="/xstudy/assets/img/image-20210716111658541.d255ad8a.png" alt="image-20210716111658541"></p> <h3 id="_2-3-2-排队等待"><a href="#_2-3-2-排队等待" class="header-anchor">#</a> 2.3.2.排队等待</h3> <p>当请求超过QPS阈值时，快速失败和warm up 会拒绝新的请求并抛出异常。</p> <p>而排队等待则是让所有请求进入一个队列中，然后按照阈值允许的时间间隔依次执行。后来的请求必须等待前面执行完成，如果请求预期的等待时间超出最大时长，则会被拒绝。</p> <p>工作原理</p> <p>例如：QPS = 5，意味着每200ms处理一个队列中的请求；timeout = 2000，意味着<strong>预期等待时长</strong>超过2000ms的请求会被拒绝并抛出异常。</p> <p>那什么叫做预期等待时长呢？</p> <p>比如现在一下子来了12 个请求，因为每200ms执行一个请求，那么：</p> <ul><li>第6个请求的<strong>预期等待时长</strong> =  200 * （6 - 1） = 1000ms</li> <li>第12个请求的预期等待时长 = 200 * （12-1） = 2200ms</li></ul> <p>现在，第1秒同时接收到10个请求，但第2秒只有1个请求，此时QPS的曲线这样的：</p> <p><img src="data:image/png;base64,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" alt="image-20210716113147176"></p> <p>如果使用队列模式做流控，所有进入的请求都要排队，以固定的200ms的间隔执行，QPS会变的很平滑：</p> <p><img src="data:image/png;base64,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" alt="image-20210716113426524"></p> <p>平滑的QPS曲线，对于服务器来说是更友好的。</p> <p><strong>案例</strong></p> <p>需求：给/order/{orderId}这个资源设置限流，最大QPS为10，利用排队的流控效果，超时时长设置为5s</p> <h4 id="_1-添加流控规则"><a href="#_1-添加流控规则" class="header-anchor">#</a> 1）添加流控规则</h4> <p><img src="/xstudy/assets/img/image-20210716114048918.4be6f815.png" alt="image-20210716114048918"></p> <h4 id="_2-jmeter测试-2"><a href="#_2-jmeter测试-2" class="header-anchor">#</a> 2）Jmeter测试</h4> <p>选择《流控效果，队列》：</p> <p><img src="/xstudy/assets/img/image-20210716114243558.816d8007.png" alt="image-20210716114243558"></p> <p>QPS为15，已经超过了我们设定的10。</p> <p>如果是之前的 快速失败、warmup模式，超出的请求应该会直接报错。</p> <p>但是我们看看队列模式的运行结果：</p> <p><img src="/xstudy/assets/img/image-20210716114429361.edb46ebf.png" alt="image-20210716114429361"></p> <p>全部都通过了。</p> <p>再去sentinel查看实时监控的QPS曲线：</p> <p><img src="/xstudy/assets/img/image-20210716114522935.07c18fe5.png" alt="image-20210716114522935"></p> <p>QPS非常平滑，一致保持在10，但是超出的请求没有被拒绝，而是放入队列。因此<strong>响应时间</strong>（等待时间）会越来越长。</p> <p>当队列满了以后，才会有部分请求失败：</p> <p><img src="/xstudy/assets/img/image-20210716114651137.c09c20a4.png" alt="image-20210716114651137"></p> <h3 id="_2-3-3-总结"><a href="#_2-3-3-总结" class="header-anchor">#</a> 2.3.3.总结</h3> <p>流控效果有哪些？</p> <ul><li><p>快速失败：QPS超过阈值时，拒绝新的请求</p></li> <li><p>warm up： QPS超过阈值时，拒绝新的请求；QPS阈值是逐渐提升的，可以避免冷启动时高并发导致服务宕机。</p></li> <li><p>排队等待：请求会进入队列，按照阈值允许的时间间隔依次执行请求；如果请求预期等待时长大于超时时间，直接拒绝</p></li></ul> <h2 id="_2-4-热点参数限流"><a href="#_2-4-热点参数限流" class="header-anchor">#</a> 2.4.热点参数限流</h2> <p>之前的限流是统计访问某个资源的所有请求，判断是否超过QPS阈值。而热点参数限流是<strong>分别统计参数值相同的请求</strong>，判断是否超过QPS阈值。</p> <h3 id="_2-4-1-全局参数限流"><a href="#_2-4-1-全局参数限流" class="header-anchor">#</a> 2.4.1.全局参数限流</h3> <p>例如，一个根据id查询商品的接口：</p> <p><img src="/xstudy/assets/img/image-20210716115014663.540c9e4f.png" alt="image-20210716115014663"></p> <p>访问/goods/{id}的请求中，id参数值会有变化，热点参数限流会根据参数值分别统计QPS，统计结果：</p> <p><img src="/xstudy/assets/img/image-20210716115131463.a37428ed.png" alt="image-20210716115131463"></p> <p>当id=1的请求触发阈值被限流时，id值不为1的请求不受影响。</p> <p>配置示例：</p> <p><img src="/xstudy/assets/img/image-20210716115232426.ec471577.png" alt="image-20210716115232426"></p> <p>代表的含义是：对hot这个资源的0号参数（第一个参数）做统计，每1秒<strong>相同参数值</strong>的请求数不能超过5</p> <h3 id="_2-4-2-热点参数限流"><a href="#_2-4-2-热点参数限流" class="header-anchor">#</a> 2.4.2.热点参数限流</h3> <p>刚才的配置中，对查询商品这个接口的所有商品一视同仁，QPS都限定为5.</p> <p>而在实际开发中，可能部分商品是热点商品，例如秒杀商品，我们希望这部分商品的QPS限制与其它商品不一样，高一些。那就需要配置热点参数限流的高级选项了：</p> <p><img src="/xstudy/assets/img/image-20210716115717523.29c32155.png" alt="image-20210716115717523"></p> <p>结合上一个配置，这里的含义是对0号的long类型参数限流，每1秒相同参数的QPS不能超过5，有两个例外：</p> <p>•如果参数值是100，则每1秒允许的QPS为10</p> <p>•如果参数值是101，则每1秒允许的QPS为15</p> <h3 id="_2-4-4-案例"><a href="#_2-4-4-案例" class="header-anchor">#</a> 2.4.4.案例</h3> <p><strong>案例需求</strong>：给/order/{orderId}这个资源添加热点参数限流，规则如下：</p> <p>•默认的热点参数规则是每1秒请求量不超过2</p> <p>•给102这个参数设置例外：每1秒请求量不超过4</p> <p>•给103这个参数设置例外：每1秒请求量不超过10</p> <p><strong>注意事项</strong>：热点参数限流对默认的SpringMVC资源无效，需要利用@SentinelResource注解标记资源</p> <h4 id="_1-标记资源"><a href="#_1-标记资源" class="header-anchor">#</a> 1）标记资源</h4> <p>给order-service中的OrderController中的/order/{orderId}资源添加注解：</p> <p><img src="/xstudy/assets/img/image-20210716120033572.b296f793.png" alt="image-20210716120033572"></p> <h4 id="_2-热点参数限流规则"><a href="#_2-热点参数限流规则" class="header-anchor">#</a> 2）热点参数限流规则</h4> <p>访问该接口，可以看到我们标记的hot资源出现了：</p> <p><img src="/xstudy/assets/img/image-20210716120208509.9d38b45b.png" alt="image-20210716120208509"></p> <p>这里不要点击hot后面的按钮，页面有BUG</p> <p>点击左侧菜单中<strong>热点规则</strong>菜单：</p> <p><img src="/xstudy/assets/img/image-20210716120319009.e585c513.png" alt="image-20210716120319009"></p> <p>点击新增，填写表单：</p> <p><img src="/xstudy/assets/img/image-20210716120536714.e3d420d9.png" alt="image-20210716120536714"></p> <h4 id="_3-jmeter测试"><a href="#_3-jmeter测试" class="header-anchor">#</a> 3）Jmeter测试</h4> <p>选择《热点参数限流 QPS1》：</p> <p><img src="/xstudy/assets/img/image-20210716120754527.b2f02281.png" alt="image-20210716120754527"></p> <p>这里发起请求的QPS为5.</p> <p>包含3个http请求：</p> <p>普通参数，QPS阈值为2</p> <p><img src="/xstudy/assets/img/image-20210716120840501.c90b9a92.png" alt="image-20210716120840501"></p> <p>运行结果：</p> <p><img src="/xstudy/assets/img/image-20210716121105567.7c23d980.png" alt="image-20210716121105567"></p> <p>例外项，QPS阈值为4</p> <p><img src="/xstudy/assets/img/image-20210716120900365.1c4f35e0.png" alt="image-20210716120900365"></p> <p>运行结果：</p> <p><img src="/xstudy/assets/img/image-20210716121201630.5e81248b.png" alt="image-20210716121201630"></p> <p>例外项，QPS阈值为10</p> <p><img src="/xstudy/assets/img/image-20210716120919131.9baad862.png" alt="image-20210716120919131"></p> <p>运行结果：</p> <p><img src="/xstudy/assets/img/image-20210716121220305.15534ecb.png" alt="image-20210716121220305"></p> <h1 id="_3-隔离和降级"><a href="#_3-隔离和降级" class="header-anchor">#</a> 3.隔离和降级</h1> <p>限流是一种预防措施，虽然限流可以尽量避免因高并发而引起的服务故障，但服务还会因为其它原因而故障。</p> <p>而要将这些故障控制在一定范围，避免雪崩，就要靠<strong>线程隔离</strong>（舱壁模式）和<strong>熔断降级</strong>手段了。</p> <p><strong>线程隔离</strong>之前讲到过：调用者在调用服务提供者时，给每个调用的请求分配独立线程池，出现故障时，最多消耗这个线程池内资源，避免把调用者的所有资源耗尽。</p> <p><img src="/xstudy/assets/img/image-20210715173215243.2391fa4b.png" alt="image-20210715173215243"></p> <p><strong>熔断降级</strong>：是在调用方这边加入断路器，统计对服务提供者的调用，如果调用的失败比例过高，则熔断该业务，不允许访问该服务的提供者了。</p> <p><img src="/xstudy/assets/img/image-20210715173428073.7bc5e928.png" alt="image-20210715173428073"></p> <p>可以看到，不管是线程隔离还是熔断降级，都是对<strong>客户端</strong>（调用方）的保护。需要在<strong>调用方</strong> 发起远程调用时做线程隔离、或者服务熔断。</p> <p>而我们的微服务远程调用都是基于Feign来完成的，因此我们需要将Feign与Sentinel整合，在Feign里面实现线程隔离和服务熔断。</p> <h2 id="_3-1-feignclient整合sentinel"><a href="#_3-1-feignclient整合sentinel" class="header-anchor">#</a> 3.1.FeignClient整合Sentinel</h2> <p>SpringCloud中，微服务调用都是通过Feign来实现的，因此做客户端保护必须整合Feign和Sentinel。</p> <h3 id="_3-1-1-修改配置-开启sentinel功能"><a href="#_3-1-1-修改配置-开启sentinel功能" class="header-anchor">#</a> 3.1.1.修改配置，开启sentinel功能</h3> <p>修改OrderService的application.yml文件，开启Feign的Sentinel功能：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 开启feign对sentinel的支持</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_3-1-2-编写失败降级逻辑"><a href="#_3-1-2-编写失败降级逻辑" class="header-anchor">#</a> 3.1.2.编写失败降级逻辑</h3> <p>业务失败后，不能直接报错，而应该返回用户一个友好提示或者默认结果，这个就是失败降级逻辑。</p> <p>给FeignClient编写失败后的降级逻辑</p> <p>①方式一：FallbackClass，无法对远程调用的异常做处理</p> <p>②方式二：FallbackFactory，可以对远程调用的异常做处理，我们选择这种</p> <p>这里我们演示方式二的失败降级处理。</p> <p><strong>步骤一</strong>：在feing-api项目中定义类，实现FallbackFactory：</p> <p><img src="/xstudy/assets/img/image-20210716122403502.6d98ea6e.png" alt="image-20210716122403502"></p> <p>代码：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>fallback</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>clients<span class="token punctuation">.</span></span><span class="token class-name">UserClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">User</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">feign<span class="token punctuation">.</span>hystrix<span class="token punctuation">.</span></span><span class="token class-name">FallbackFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserClientFallbackFactory</span> <span class="token keyword">implements</span> <span class="token class-name">FallbackFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserClient</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserClient</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UserClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;查询用户异常&quot;</span><span class="token punctuation">,</span> throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><strong>步骤二</strong>：在feing-api项目中的DefaultFeignConfiguration类中将UserClientFallbackFactory注册为一个Bean：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">UserClientFallbackFactory</span> <span class="token function">userClientFallbackFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UserClientFallbackFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>步骤三</strong>：在feing-api项目中的UserClient接口中使用UserClientFallbackFactory：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>fallback<span class="token punctuation">.</span></span><span class="token class-name">UserClientFallbackFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">User</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PathVariable</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;userservice&quot;</span><span class="token punctuation">,</span> fallbackFactory <span class="token operator">=</span> <span class="token class-name">UserClientFallbackFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserClient</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/user/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">User</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>重启后，访问一次订单查询业务，然后查看sentinel控制台，可以看到新的簇点链路：</p> <p><img src="/xstudy/assets/img/image-20210716123705780.e8de5515.png" alt="image-20210716123705780"></p> <h3 id="_3-1-3-总结"><a href="#_3-1-3-总结" class="header-anchor">#</a> 3.1.3.总结</h3> <p>Sentinel支持的雪崩解决方案：</p> <ul><li>线程隔离（仓壁模式）</li> <li>降级熔断</li></ul> <p>Feign整合Sentinel的步骤：</p> <ul><li>在application.yml中配置：feign.sentienl.enable=true</li> <li>给FeignClient编写FallbackFactory并注册为Bean</li> <li>将FallbackFactory配置到FeignClient</li></ul> <h2 id="_3-2-线程隔离-舱壁模式"><a href="#_3-2-线程隔离-舱壁模式" class="header-anchor">#</a> 3.2.线程隔离（舱壁模式）</h2> <h3 id="_3-2-1-线程隔离的实现方式"><a href="#_3-2-1-线程隔离的实现方式" class="header-anchor">#</a> 3.2.1.线程隔离的实现方式</h3> <p>线程隔离有两种方式实现：</p> <ul><li><p>线程池隔离</p></li> <li><p>信号量隔离（Sentinel默认采用）</p></li></ul> <p>如图：</p> <p><img src="/xstudy/assets/img/image-20210716123036937.7f39d5cd.png" alt="image-20210716123036937"></p> <p><strong>线程池隔离</strong>：给每个服务调用业务分配一个线程池，利用线程池本身实现隔离效果</p> <p><strong>信号量隔离</strong>：不创建线程池，而是计数器模式，记录业务使用的线程数量，达到信号量上限时，禁止新的请求。</p> <p>两者的优缺点：</p> <p><img src="/xstudy/assets/img/image-20210716123240518.b4f637e2.png" alt="image-20210716123240518"></p> <h3 id="_3-2-2-sentinel的线程隔离"><a href="#_3-2-2-sentinel的线程隔离" class="header-anchor">#</a> 3.2.2.sentinel的线程隔离</h3> <p><strong>用法说明</strong>：</p> <p>在添加限流规则时，可以选择两种阈值类型：</p> <p><img src="/xstudy/assets/img/image-20210716123411217.c4d9d0bd.png" alt="image-20210716123411217"></p> <ul><li><p>QPS：就是每秒的请求数，在快速入门中已经演示过</p></li> <li><p>线程数：是该资源能使用用的tomcat线程数的最大值。也就是通过限制线程数量，实现<strong>线程隔离</strong>（舱壁模式）。</p></li></ul> <p><strong>案例需求</strong>：给 order-service服务中的UserClient的查询用户接口设置流控规则，线程数不能超过 2。然后利用jemeter测试。</p> <h4 id="_1-配置隔离规则"><a href="#_1-配置隔离规则" class="header-anchor">#</a> 1）配置隔离规则</h4> <p>选择feign接口后面的流控按钮：</p> <p><img src="/xstudy/assets/img/image-20210716123831992.effa10e1.png" alt="image-20210716123831992"></p> <p>填写表单：</p> <p><img src="/xstudy/assets/img/image-20210716123936844.a4091332.png" alt="image-20210716123936844"></p> <h4 id="_2-jmeter测试-3"><a href="#_2-jmeter测试-3" class="header-anchor">#</a> 2）Jmeter测试</h4> <p>选择《阈值类型-线程数&lt;2》：</p> <p><img src="/xstudy/assets/img/image-20210716124229894.19d36764.png" alt="image-20210716124229894"></p> <p>一次发生10个请求，有较大概率并发线程数超过2，而超出的请求会走之前定义的失败降级逻辑。</p> <p>查看运行结果：</p> <p><img src="/xstudy/assets/img/image-20210716124147820.03db0476.png" alt="image-20210716124147820"></p> <p>发现虽然结果都是通过了，不过部分请求得到的响应是降级返回的null信息。</p> <h3 id="_3-2-3-总结"><a href="#_3-2-3-总结" class="header-anchor">#</a> 3.2.3.总结</h3> <p>线程隔离的两种手段是？</p> <ul><li><p>信号量隔离</p></li> <li><p>线程池隔离</p></li></ul> <p>信号量隔离的特点是？</p> <ul><li>基于计数器模式，简单，开销小</li></ul> <p>线程池隔离的特点是？</p> <ul><li>基于线程池模式，有额外开销，但隔离控制更强</li></ul> <h2 id="_3-3-熔断降级"><a href="#_3-3-熔断降级" class="header-anchor">#</a> 3.3.熔断降级</h2> <p>熔断降级是解决雪崩问题的重要手段。其思路是由<strong>断路器</strong>统计服务调用的异常比例、慢请求比例，如果超出阈值则会<strong>熔断</strong>该服务。即拦截访问该服务的一切请求；而当服务恢复时，断路器会放行访问该服务的请求。</p> <p>断路器控制熔断和放行是通过状态机来完成的：</p> <p><img src="/xstudy/assets/img/image-20210716130958518.d7fc1677.png" alt="image-20210716130958518"></p> <p>状态机包括三个状态：</p> <ul><li>closed：关闭状态，断路器放行所有请求，并开始统计异常比例、慢请求比例。超过阈值则切换到open状态</li> <li>open：打开状态，服务调用被<strong>熔断</strong>，访问被熔断服务的请求会被拒绝，快速失败，直接走降级逻辑。Open状态5秒后会进入half-open状态</li> <li>half-open：半开状态，放行一次请求，根据执行结果来判断接下来的操作。
<ul><li>请求成功：则切换到closed状态</li> <li>请求失败：则切换到open状态</li></ul></li></ul> <p>断路器熔断策略有三种：慢调用、异常比例、异常数</p> <h3 id="_3-3-1-慢调用"><a href="#_3-3-1-慢调用" class="header-anchor">#</a> 3.3.1.慢调用</h3> <p><strong>慢调用</strong>：业务的响应时长（RT）大于指定时长的请求认定为慢调用请求。在指定时间内，如果请求数量超过设定的最小数量，慢调用比例大于设定的阈值，则触发熔断。</p> <p>例如：</p> <p><img src="/xstudy/assets/img/image-20210716145934347.5abdcae8.png" alt="image-20210716145934347"></p> <p>解读：RT超过500ms的调用是慢调用，统计最近10000ms内的请求，如果请求量超过10次，并且慢调用比例不低于0.5，则触发熔断，熔断时长为5秒。然后进入half-open状态，放行一次请求做测试。</p> <p><strong>案例</strong></p> <p>需求：给 UserClient的查询用户接口设置降级规则，慢调用的RT阈值为50ms，统计时间为1秒，最小请求数量为5，失败阈值比例为0.4，熔断时长为5</p> <h4 id="_1-设置慢调用"><a href="#_1-设置慢调用" class="header-anchor">#</a> 1）设置慢调用</h4> <p>修改user-service中的/user/{id}这个接口的业务。通过休眠模拟一个延迟时间：</p> <p><img src="/xstudy/assets/img/image-20210716150234787.1050eaaf.png" alt="image-20210716150234787"></p> <p>此时，orderId=101的订单，关联的是id为1的用户，调用时长为60ms：</p> <p><img src="/xstudy/assets/img/image-20210716150510956.1428b673.png" alt="image-20210716150510956"></p> <p>orderId=102的订单，关联的是id为2的用户，调用时长为非常短；</p> <p><img src="/xstudy/assets/img/image-20210716150605208.38ca01d3.png" alt="image-20210716150605208"></p> <h4 id="_2-设置熔断规则"><a href="#_2-设置熔断规则" class="header-anchor">#</a> 2）设置熔断规则</h4> <p>下面，给feign接口设置降级规则：</p> <p><img src="/xstudy/assets/img/image-20210716150654094.d19bf916.png" alt="image-20210716150654094"></p> <p>规则：</p> <p><img src="/xstudy/assets/img/image-20210716150740434.02268674.png" alt="image-20210716150740434"></p> <p>超过50ms的请求都会被认为是慢请求</p> <h4 id="_3-测试"><a href="#_3-测试" class="header-anchor">#</a> 3）测试</h4> <p>在浏览器访问：http://localhost:8088/order/101，快速刷新5次，可以发现：</p> <p><img src="/xstudy/assets/img/image-20210716150911004.b70dd7c5.png" alt="image-20210716150911004"></p> <p>触发了熔断，请求时长缩短至5ms，快速失败了，并且走降级逻辑，返回的null</p> <p>在浏览器访问：http://localhost:8088/order/102，竟然也被熔断了：</p> <p><img src="/xstudy/assets/img/image-20210716151107785.560b40e3.png" alt="image-20210716151107785"></p> <h3 id="_3-3-2-异常比例、异常数"><a href="#_3-3-2-异常比例、异常数" class="header-anchor">#</a> 3.3.2.异常比例、异常数</h3> <p><strong>异常比例或异常数</strong>：统计指定时间内的调用，如果调用次数超过指定请求数，并且出现异常的比例达到设定的比例阈值（或超过指定异常数），则触发熔断。</p> <p>例如，一个异常比例设置：</p> <p><img src="/xstudy/assets/img/image-20210716131430682.bc152107.png" alt="image-20210716131430682"></p> <p>解读：统计最近1000ms内的请求，如果请求量超过10次，并且异常比例不低于0.4，则触发熔断。</p> <p>一个异常数设置：</p> <p><img src="/xstudy/assets/img/image-20210716131522912.d986a5a4.png" alt="image-20210716131522912"></p> <p>解读：统计最近1000ms内的请求，如果请求量超过10次，并且异常比例不低于2次，则触发熔断。</p> <p><strong>案例</strong></p> <p>需求：给 UserClient的查询用户接口设置降级规则，统计时间为1秒，最小请求数量为5，失败阈值比例为0.4，熔断时长为5s</p> <h4 id="_1-设置异常请求"><a href="#_1-设置异常请求" class="header-anchor">#</a> 1）设置异常请求</h4> <p>首先，修改user-service中的/user/{id}这个接口的业务。手动抛出异常，以触发异常比例的熔断：</p> <p><img src="/xstudy/assets/img/image-20210716151348183.92785eb0.png" alt="image-20210716151348183"></p> <p>也就是说，id 为 2时，就会触发异常</p> <h4 id="_2-设置熔断规则-2"><a href="#_2-设置熔断规则-2" class="header-anchor">#</a> 2）设置熔断规则</h4> <p>下面，给feign接口设置降级规则：</p> <p><img src="/xstudy/assets/img/image-20210716150654094.d19bf916.png" alt="image-20210716150654094"></p> <p>规则：</p> <p><img src="/xstudy/assets/img/image-20210716151538785.9a9184f1.png" alt="image-20210716151538785"></p> <p>在5次请求中，只要异常比例超过0.4，也就是有2次以上的异常，就会触发熔断。</p> <h4 id="_3-测试-2"><a href="#_3-测试-2" class="header-anchor">#</a> 3）测试</h4> <p>在浏览器快速访问：http://localhost:8088/order/102，快速刷新5次，触发熔断：</p> <p><img src="/xstudy/assets/img/image-20210716151722916.f8c8fc58.png" alt="image-20210716151722916"></p> <p>此时，我们去访问本来应该正常的103：</p> <p><img src="/xstudy/assets/img/image-20210716151844817.8d590050.png" alt="image-20210716151844817"></p> <h1 id="_4-授权规则"><a href="#_4-授权规则" class="header-anchor">#</a> 4.授权规则</h1> <p>授权规则可以对请求方来源做判断和控制。</p> <h2 id="_4-1-授权规则"><a href="#_4-1-授权规则" class="header-anchor">#</a> 4.1.授权规则</h2> <h3 id="_4-1-1-基本规则"><a href="#_4-1-1-基本规则" class="header-anchor">#</a> 4.1.1.基本规则</h3> <p>授权规则可以对调用方的来源做控制，有白名单和黑名单两种方式。</p> <ul><li><p>白名单：来源（origin）在白名单内的调用者允许访问</p></li> <li><p>黑名单：来源（origin）在黑名单内的调用者不允许访问</p></li></ul> <p>点击左侧菜单的授权，可以看到授权规则：</p> <p><img src="/xstudy/assets/img/image-20210716152010750.c6be95de.png" alt="image-20210716152010750"></p> <ul><li><p>资源名：就是受保护的资源，例如/order/{orderId}</p></li> <li><p>流控应用：是来源者的名单，</p> <ul><li>如果是勾选白名单，则名单中的来源被许可访问。</li> <li>如果是勾选黑名单，则名单中的来源被禁止访问。</li></ul></li></ul> <p>比如：</p> <p><img src="/xstudy/assets/img/image-20210716152349191.a48dfb97.png" alt="image-20210716152349191"></p> <p>我们允许请求从gateway到order-service，不允许浏览器访问order-service，那么白名单中就要填写<strong>网关的来源名称（origin）</strong>。</p> <h3 id="_4-1-2-如何获取origin"><a href="#_4-1-2-如何获取origin" class="header-anchor">#</a> 4.1.2.如何获取origin</h3> <p>Sentinel是通过RequestOriginParser这个接口的parseOrigin来获取请求的来源的。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RequestOriginParser</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 从请求request对象中获取origin，获取方式自定义
     */</span>
    <span class="token class-name">String</span> <span class="token function">parseOrigin</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这个方法的作用就是从request对象中，获取请求者的origin值并返回。</p> <p>默认情况下，sentinel不管请求者从哪里来，返回值永远是default，也就是说一切请求的来源都被认为是一样的值default。</p> <p>因此，我们需要自定义这个接口的实现，让<strong>不同的请求，返回不同的origin</strong>。</p> <p>例如order-service服务中，我们定义一个RequestOriginParser的实现类：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>order<span class="token punctuation">.</span>sentinel</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>adapter<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>webmvc<span class="token punctuation">.</span>callback<span class="token punctuation">.</span></span><span class="token class-name">RequestOriginParser</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HeaderOriginParser</span> <span class="token keyword">implements</span> <span class="token class-name">RequestOriginParser</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">parseOrigin</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.获取请求头</span>
        <span class="token class-name">String</span> origin <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;origin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.非空判断</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            origin <span class="token operator">=</span> <span class="token string">&quot;blank&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> origin<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>我们会尝试从request-header中获取origin值。</p> <h3 id="_4-1-3-给网关添加请求头"><a href="#_4-1-3-给网关添加请求头" class="header-anchor">#</a> 4.1.3.给网关添加请求头</h3> <p>既然获取请求origin的方式是从reques-header中获取origin值，我们必须让<strong>所有从gateway路由到微服务的请求都带上origin头</strong>。</p> <p>这个需要利用之前学习的一个GatewayFilter来实现，AddRequestHeaderGatewayFilter。</p> <p>修改gateway服务中的application.yml，添加一个defaultFilter：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">default-filters</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> AddRequestHeader=origin<span class="token punctuation">,</span>gateway
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
       <span class="token comment"># ...略</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>这样，从gateway路由的所有请求都会带上origin头，值为gateway。而从其它地方到达微服务的请求则没有这个头。</p> <h3 id="_4-1-4-配置授权规则"><a href="#_4-1-4-配置授权规则" class="header-anchor">#</a> 4.1.4.配置授权规则</h3> <p>接下来，我们添加一个授权规则，放行origin值为gateway的请求。</p> <p><img src="/xstudy/assets/img/image-20210716153250134.e804f0bf.png" alt="image-20210716153250134"></p> <p>配置如下：</p> <p><img src="/xstudy/assets/img/image-20210716153301069.aaedf670.png" alt="image-20210716153301069"></p> <p>现在，我们直接跳过网关，访问order-service服务：</p> <p><img src="/xstudy/assets/img/image-20210716153348396.0cefed78.png" alt="image-20210716153348396"></p> <p>通过网关访问：</p> <p><img src="/xstudy/assets/img/image-20210716153434095.116bf9a4.png" alt="image-20210716153434095"></p> <h2 id="_4-2-自定义异常结果"><a href="#_4-2-自定义异常结果" class="header-anchor">#</a> 4.2.自定义异常结果</h2> <p>默认情况下，发生限流、降级、授权拦截时，都会抛出异常到调用方。异常结果都是flow limmiting（限流）。这样不够友好，无法得知是限流还是降级还是授权拦截。</p> <h3 id="_4-2-1-异常类型"><a href="#_4-2-1-异常类型" class="header-anchor">#</a> 4.2.1.异常类型</h3> <p>而如果要自定义异常时的返回结果，需要实现BlockExceptionHandler接口：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BlockExceptionHandler</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 处理请求被限流、降级、授权拦截时抛出的异常：BlockException
     */</span>
    <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">BlockException</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这个方法有三个参数：</p> <ul><li>HttpServletRequest request：request对象</li> <li>HttpServletResponse response：response对象</li> <li>BlockException e：被sentinel拦截时抛出的异常</li></ul> <p>这里的BlockException包含多个不同的子类：</p> <table><thead><tr><th><strong>异常</strong></th> <th><strong>说明</strong></th></tr></thead> <tbody><tr><td>FlowException</td> <td>限流异常</td></tr> <tr><td>ParamFlowException</td> <td>热点参数限流的异常</td></tr> <tr><td>DegradeException</td> <td>降级异常</td></tr> <tr><td>AuthorityException</td> <td>授权规则异常</td></tr> <tr><td>SystemBlockException</td> <td>系统规则异常</td></tr></tbody></table> <h3 id="_4-2-2-自定义异常处理"><a href="#_4-2-2-自定义异常处理" class="header-anchor">#</a> 4.2.2.自定义异常处理</h3> <p>下面，我们就在order-service定义一个自定义异常处理类：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>order<span class="token punctuation">.</span>sentinel</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>adapter<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>webmvc<span class="token punctuation">.</span>callback<span class="token punctuation">.</span></span><span class="token class-name">BlockExceptionHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>block<span class="token punctuation">.</span></span><span class="token class-name">BlockException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>block<span class="token punctuation">.</span>authority<span class="token punctuation">.</span></span><span class="token class-name">AuthorityException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>block<span class="token punctuation">.</span>degrade<span class="token punctuation">.</span></span><span class="token class-name">DegradeException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>block<span class="token punctuation">.</span>flow<span class="token punctuation">.</span></span><span class="token class-name">FlowException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>block<span class="token punctuation">.</span>flow<span class="token punctuation">.</span>param<span class="token punctuation">.</span></span><span class="token class-name">ParamFlowException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SentinelExceptionHandler</span> <span class="token keyword">implements</span> <span class="token class-name">BlockExceptionHandler</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">BlockException</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token string">&quot;未知异常&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> status <span class="token operator">=</span> <span class="token number">429</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">FlowException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            msg <span class="token operator">=</span> <span class="token string">&quot;请求被限流了&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">ParamFlowException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            msg <span class="token operator">=</span> <span class="token string">&quot;请求被热点参数限流&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">DegradeException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            msg <span class="token operator">=</span> <span class="token string">&quot;请求被降级了&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">AuthorityException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            msg <span class="token operator">=</span> <span class="token string">&quot;没有权限访问&quot;</span><span class="token punctuation">;</span>
            status <span class="token operator">=</span> <span class="token number">401</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;application/json;charset=utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;{\&quot;msg\&quot;: &quot;</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">&quot;, \&quot;status\&quot;: &quot;</span> <span class="token operator">+</span> status <span class="token operator">+</span> <span class="token string">&quot;}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>重启测试，在不同场景下，会返回不同的异常消息.</p> <p>限流：</p> <p><img src="/xstudy/assets/img/image-20210716153938887.d3b874e2.png" alt="image-20210716153938887"></p> <p>授权拦截时：</p> <p><img src="/xstudy/assets/img/image-20210716154012736.4bb5a436.png" alt="image-20210716154012736"></p> <h1 id="_5-规则持久化"><a href="#_5-规则持久化" class="header-anchor">#</a> 5.规则持久化</h1> <p>现在，sentinel的所有规则都是内存存储，重启后所有规则都会丢失。在生产环境下，我们必须确保这些规则的持久化，避免丢失。</p> <h2 id="_5-1-规则管理模式"><a href="#_5-1-规则管理模式" class="header-anchor">#</a> 5.1.规则管理模式</h2> <p>规则是否能持久化，取决于规则管理模式，sentinel支持三种规则管理模式：</p> <ul><li>原始模式：Sentinel的默认模式，将规则保存在内存，重启服务会丢失。</li> <li>pull模式</li> <li>push模式</li></ul> <h3 id="_5-1-1-pull模式"><a href="#_5-1-1-pull模式" class="header-anchor">#</a> 5.1.1.pull模式</h3> <p>pull模式：控制台将配置的规则推送到Sentinel客户端，而客户端会将配置规则保存在本地文件或数据库中。以后会定时去本地文件或数据库中查询，更新本地规则。</p> <p><img src="/xstudy/assets/img/image-20210716154155238.65f1b8ad.png" alt="image-20210716154155238"></p> <h3 id="_5-1-2-push模式"><a href="#_5-1-2-push模式" class="header-anchor">#</a> 5.1.2.push模式</h3> <p>push模式：控制台将配置规则推送到远程配置中心，例如Nacos。Sentinel客户端监听Nacos，获取配置变更的推送消息，完成本地配置更新。</p> <p><img src="/xstudy/assets/img/image-20210716154215456.6400e8de.png" alt="image-20210716154215456"></p> <h2 id="_5-2-实现push模式"><a href="#_5-2-实现push模式" class="header-anchor">#</a> 5.2.实现push模式</h2> <p>详细步骤可以参考课前资料的《sentinel规则持久化》：</p> <p><img src="/xstudy/assets/img/image-20210716154255466.60db6486.png" alt="image-20210716154255466"></p></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/xstudy/blogs/frame/Spring-Cloud/SpringCloud02.html" class="prev">
            Spring Cloud 02
          </a></span> <span class="next"><a href="/xstudy/blogs/frame/Spring-Cloud/Seata.html">
            分布式事务
          </a></span></p></div> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-70334359><li class="level-2" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_1-1-雪崩问题及解决方案" class="sidebar-link reco-side-_1-1-雪崩问题及解决方案" data-v-70334359>1.1.雪崩问题及解决方案</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_1-1-1-雪崩问题" class="sidebar-link reco-side-_1-1-1-雪崩问题" data-v-70334359>1.1.1.雪崩问题</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_1-1-2-超时处理" class="sidebar-link reco-side-_1-1-2-超时处理" data-v-70334359>1.1.2.超时处理</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_1-1-3-仓壁模式" class="sidebar-link reco-side-_1-1-3-仓壁模式" data-v-70334359>1.1.3.仓壁模式</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_1-1-4-断路器" class="sidebar-link reco-side-_1-1-4-断路器" data-v-70334359>1.1.4.断路器</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_1-1-5-限流" class="sidebar-link reco-side-_1-1-5-限流" data-v-70334359>1.1.5.限流</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_1-1-6-总结" class="sidebar-link reco-side-_1-1-6-总结" data-v-70334359>1.1.6.总结</a></li><li class="level-2" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_1-2-服务保护技术对比" class="sidebar-link reco-side-_1-2-服务保护技术对比" data-v-70334359>1.2.服务保护技术对比</a></li><li class="level-2" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_1-3-sentinel介绍和安装" class="sidebar-link reco-side-_1-3-sentinel介绍和安装" data-v-70334359>1.3.Sentinel介绍和安装</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_1-3-1-初识sentinel" class="sidebar-link reco-side-_1-3-1-初识sentinel" data-v-70334359>1.3.1.初识Sentinel</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_1-3-2-安装sentinel" class="sidebar-link reco-side-_1-3-2-安装sentinel" data-v-70334359>1.3.2.安装Sentinel</a></li><li class="level-2" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_1-4-微服务整合sentinel" class="sidebar-link reco-side-_1-4-微服务整合sentinel" data-v-70334359>1.4.微服务整合Sentinel</a></li><li class="level-2" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_2-1-簇点链路" class="sidebar-link reco-side-_2-1-簇点链路" data-v-70334359>2.1.簇点链路</a></li><li class="level-2" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_2-1-快速入门" class="sidebar-link reco-side-_2-1-快速入门" data-v-70334359>2.1.快速入门</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_2-1-1-示例" class="sidebar-link reco-side-_2-1-1-示例" data-v-70334359>2.1.1.示例</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_2-1-2-练习" class="sidebar-link reco-side-_2-1-2-练习" data-v-70334359>2.1.2.练习：</a></li><li class="level-2" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_2-2-流控模式" class="sidebar-link reco-side-_2-2-流控模式" data-v-70334359>2.2.流控模式</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_2-2-1-关联模式" class="sidebar-link reco-side-_2-2-1-关联模式" data-v-70334359>2.2.1.关联模式</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_2-2-2-链路模式" class="sidebar-link reco-side-_2-2-2-链路模式" data-v-70334359>2.2.2.链路模式</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_2-2-3-总结" class="sidebar-link reco-side-_2-2-3-总结" data-v-70334359>2.2.3.总结</a></li><li class="level-2" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_2-3-流控效果" class="sidebar-link reco-side-_2-3-流控效果" data-v-70334359>2.3.流控效果</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_2-3-1-warm-up" class="sidebar-link reco-side-_2-3-1-warm-up" data-v-70334359>2.3.1.warm up</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_2-3-2-排队等待" class="sidebar-link reco-side-_2-3-2-排队等待" data-v-70334359>2.3.2.排队等待</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_2-3-3-总结" class="sidebar-link reco-side-_2-3-3-总结" data-v-70334359>2.3.3.总结</a></li><li class="level-2" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_2-4-热点参数限流" class="sidebar-link reco-side-_2-4-热点参数限流" data-v-70334359>2.4.热点参数限流</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_2-4-1-全局参数限流" class="sidebar-link reco-side-_2-4-1-全局参数限流" data-v-70334359>2.4.1.全局参数限流</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_2-4-2-热点参数限流" class="sidebar-link reco-side-_2-4-2-热点参数限流" data-v-70334359>2.4.2.热点参数限流</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_2-4-4-案例" class="sidebar-link reco-side-_2-4-4-案例" data-v-70334359>2.4.4.案例</a></li><li class="level-2" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_3-1-feignclient整合sentinel" class="sidebar-link reco-side-_3-1-feignclient整合sentinel" data-v-70334359>3.1.FeignClient整合Sentinel</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_3-1-1-修改配置-开启sentinel功能" class="sidebar-link reco-side-_3-1-1-修改配置-开启sentinel功能" data-v-70334359>3.1.1.修改配置，开启sentinel功能</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_3-1-2-编写失败降级逻辑" class="sidebar-link reco-side-_3-1-2-编写失败降级逻辑" data-v-70334359>3.1.2.编写失败降级逻辑</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_3-1-3-总结" class="sidebar-link reco-side-_3-1-3-总结" data-v-70334359>3.1.3.总结</a></li><li class="level-2" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_3-2-线程隔离-舱壁模式" class="sidebar-link reco-side-_3-2-线程隔离-舱壁模式" data-v-70334359>3.2.线程隔离（舱壁模式）</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_3-2-1-线程隔离的实现方式" class="sidebar-link reco-side-_3-2-1-线程隔离的实现方式" data-v-70334359>3.2.1.线程隔离的实现方式</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_3-2-2-sentinel的线程隔离" class="sidebar-link reco-side-_3-2-2-sentinel的线程隔离" data-v-70334359>3.2.2.sentinel的线程隔离</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_3-2-3-总结" class="sidebar-link reco-side-_3-2-3-总结" data-v-70334359>3.2.3.总结</a></li><li class="level-2" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_3-3-熔断降级" class="sidebar-link reco-side-_3-3-熔断降级" data-v-70334359>3.3.熔断降级</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_3-3-1-慢调用" class="sidebar-link reco-side-_3-3-1-慢调用" data-v-70334359>3.3.1.慢调用</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_3-3-2-异常比例、异常数" class="sidebar-link reco-side-_3-3-2-异常比例、异常数" data-v-70334359>3.3.2.异常比例、异常数</a></li><li class="level-2" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_4-1-授权规则" class="sidebar-link reco-side-_4-1-授权规则" data-v-70334359>4.1.授权规则</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_4-1-1-基本规则" class="sidebar-link reco-side-_4-1-1-基本规则" data-v-70334359>4.1.1.基本规则</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_4-1-2-如何获取origin" class="sidebar-link reco-side-_4-1-2-如何获取origin" data-v-70334359>4.1.2.如何获取origin</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_4-1-3-给网关添加请求头" class="sidebar-link reco-side-_4-1-3-给网关添加请求头" data-v-70334359>4.1.3.给网关添加请求头</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_4-1-4-配置授权规则" class="sidebar-link reco-side-_4-1-4-配置授权规则" data-v-70334359>4.1.4.配置授权规则</a></li><li class="level-2" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_4-2-自定义异常结果" class="sidebar-link reco-side-_4-2-自定义异常结果" data-v-70334359>4.2.自定义异常结果</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_4-2-1-异常类型" class="sidebar-link reco-side-_4-2-1-异常类型" data-v-70334359>4.2.1.异常类型</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_4-2-2-自定义异常处理" class="sidebar-link reco-side-_4-2-2-自定义异常处理" data-v-70334359>4.2.2.自定义异常处理</a></li><li class="level-2" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_5-1-规则管理模式" class="sidebar-link reco-side-_5-1-规则管理模式" data-v-70334359>5.1.规则管理模式</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_5-1-1-pull模式" class="sidebar-link reco-side-_5-1-1-pull模式" data-v-70334359>5.1.1.pull模式</a></li><li class="level-3" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_5-1-2-push模式" class="sidebar-link reco-side-_5-1-2-push模式" data-v-70334359>5.1.2.push模式</a></li><li class="level-2" data-v-70334359><a href="/xstudy/blogs/frame/Spring-Cloud/Sentinel.html#_5-2-实现push模式" class="sidebar-link reco-side-_5-2-实现push模式" data-v-70334359>5.2.实现push模式</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><div class="kanbanniang" data-v-5775ee02><div class="banniang-container" style="display:;" data-v-5775ee02><div class="messageBox" style="right:10px;bottom:170px;z-index:999999;display:none;" data-v-5775ee02>
      我是X欢迎你的关注 
    </div> <div class="operation" style="right:90px;bottom:40px;display:;" data-v-5775ee02><i class="kbnfont kbn-ban-home ban-home" data-v-5775ee02></i> <i class="kbnfont kbn-ban-message message" data-v-5775ee02></i> <i class="kbnfont kbn-ban-close close" data-v-5775ee02></i> <a target="_blank" href="https://vuepress-theme-reco.recoluan.com/views/plugins/kanbanniang.html" data-v-5775ee02><i class="kbnfont kbn-ban-info info" data-v-5775ee02></i></a> <i class="kbnfont kbn-ban-theme skin" style="display:;" data-v-5775ee02></i></div> <canvas id="banniang" width="192" height="281" class="live2d" style="right:65px;bottom:-20px;opacity:0.85;" data-v-5775ee02></canvas></div> <div class="showBanNiang" style="display:none;" data-v-5775ee02>
    看板娘
  </div></div><canvas id="vuepress-canvas-ribbon"></canvas><div></div><div class="Sakura" data-v-248d85d6><canvas id="canvas_sakura" style="z-index:-1;" data-v-248d85d6></canvas></div></div></div>
    <script src="/xstudy/assets/js/app.3d6c3b03.js" defer></script><script src="/xstudy/assets/js/19.64802264.js" defer></script><script src="/xstudy/assets/js/1.09d9e8ff.js" defer></script><script src="/xstudy/assets/js/3.4370b068.js" defer></script>
  </body>
</html>
